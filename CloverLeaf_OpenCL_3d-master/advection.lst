


PGF90 (Version     13.5)          07/18/2014  14:45:36      page 1

Switches: -noasm -nodclchk -debug -nodlines -line -list
          -idir /usr/mpi/pgi/mvapich2-1.7-qlc/include
          -idir /usr/mpi/pgi/mvapich2-1.7-qlc/include
          -inform severe -opt 2 -nosave -object -noonetrip
          -depchk on -nostandard     
          -symbol -noupcase    

Filename: advection.f90

(    1) !Crown Copyright 2012 AWE.
(    2) !
(    3) ! This file is part of CloverLeaf.
(    4) !
(    5) ! CloverLeaf is free software: you can redistribute it and/or modify it under 
(    6) ! the terms of the GNU General Public License as published by the 
(    7) ! Free Software Foundation, either version 3 of the License, or (at your option) 
(    8) ! any later version.
(    9) !
(   10) ! CloverLeaf is distributed in the hope that it will be useful, but 
(   11) ! WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or 
(   12) ! FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more 
(   13) ! details.
(   14) !
(   15) ! You should have received a copy of the GNU General Public License along with 
(   16) ! CloverLeaf. If not, see http://www.gnu.org/licenses/.
(   17) 
(   18) !>  @brief Top level advection driver
(   19) !>  @author Wayne Gaudin
(   20) !>  @details Controls the advection step and invokes required communications.
(   21) 
(   22) MODULE advection_module
(   23) 
(   24) CONTAINS
(   25) 
(   26) SUBROUTINE advection()
(   27) 
(   28)   USE clover_module
(   29)   USE advec_cell_driver_module
(   30)   USE advec_mom_driver_module
(   31)   USE update_halo_module
(   32) 
(   33)   IMPLICIT NONE
(   34) 
(   35)   INTEGER :: sweep_number,direction,c
(   36) 
(   37)   INTEGER :: xvel,yvel,zvel
(   38) 
(   39)   INTEGER :: fields(NUM_FIELDS)
(   40) 
(   41)   REAL(KIND=8) :: kernel_time,timer
(   42) 
(   43)   sweep_number=1
(   44)   IF(advect_x)      direction=g_xdir
(   45)   IF(.not.advect_x) direction=g_zdir
(   46)   xvel=g_xdir
(   47)   yvel=g_ydir
(   48)   zvel=g_zdir
(   49) 
(   50)   fields=0






PGF90 (Version     13.5)          07/18/2014  14:45:36      page 2

(   51)   fields(FIELD_ENERGY1)=1
(   52)   fields(FIELD_DENSITY1)=1
(   53)   fields(FIELD_VOL_FLUX_X)=1
(   54)   fields(FIELD_VOL_FLUX_Y)=1
(   55)   fields(FIELD_VOL_FLUX_Z)=1
(   56)   IF(profiler_on) kernel_time=timer()
(   57)   CALL update_halo(fields,2)
(   58)   IF(profiler_on) profiler%halo_exchange=profiler%halo_exchange+(timer()-kernel_time)
(   59) 
(   60)   IF(profiler_on) kernel_time=timer()
(   61)   DO c=1,chunks_per_task
(   62)     CALL advec_cell_driver(c,sweep_number,direction)
(   63)   ENDDO
(   64)   IF(profiler_on) profiler%cell_advection=profiler%cell_advection+(timer()-kernel_time)
(   65) 
(   66)   fields=0
(   67)   fields(FIELD_DENSITY1)=1
(   68)   fields(FIELD_ENERGY1)=1
(   69)   fields(FIELD_XVEL1)=1
(   70)   fields(FIELD_YVEL1)=1
(   71)   fields(FIELD_ZVEL1)=1
(   72)   fields(FIELD_MASS_FLUX_X)=1
(   73)   fields(FIELD_MASS_FLUX_Y)=1
(   74)   fields(FIELD_MASS_FLUX_Z)=1
(   75)   IF(profiler_on) kernel_time=timer()
(   76)   CALL update_halo(fields,2)
(   77)   IF(profiler_on) profiler%halo_exchange=profiler%halo_exchange+(timer()-kernel_time)
(   78) 
(   79)   IF(profiler_on) kernel_time=timer()
(   80)   DO c=1,chunks_per_task
(   81)     CALL advec_mom_driver(c,xvel,direction,sweep_number) 
(   82)   ENDDO
(   83)   DO c=1,chunks_per_task
(   84)     CALL advec_mom_driver(c,yvel,direction,sweep_number) 
(   85)   ENDDO
(   86)   DO c=1,chunks_per_task
(   87)     CALL advec_mom_driver(c,zvel,direction,sweep_number) 
(   88)   ENDDO
(   89)   IF(profiler_on) profiler%mom_advection=profiler%mom_advection+(timer()-kernel_time)
(   90) 
(   91)   sweep_number=2
(   92)   direction=g_ydir
(   93) 
(   94)   fields=0
(   95)   fields(FIELD_ENERGY1)=1
(   96)   fields(FIELD_DENSITY1)=1
(   97)   fields(FIELD_VOL_FLUX_X)=1
(   98)   fields(FIELD_VOL_FLUX_Y)=1
(   99)   fields(FIELD_VOL_FLUX_Z)=1
(  100)   IF(profiler_on) kernel_time=timer()
(  101)   CALL update_halo(fields,2)
(  102)   IF(profiler_on) profiler%halo_exchange=profiler%halo_exchange+(timer()-kernel_time)
(  103) 
(  104)   IF(profiler_on) kernel_time=timer()
(  105)   DO c=1,chunks_per_task
(  106)     CALL advec_cell_driver(c,sweep_number,direction)
(  107)   ENDDO
(  108)   IF(profiler_on) profiler%cell_advection=profiler%cell_advection+(timer()-kernel_time)






PGF90 (Version     13.5)          07/18/2014  14:45:36      page 3

(  109) 
(  110)   fields=0
(  111)   fields(FIELD_DENSITY1)=1
(  112)   fields(FIELD_ENERGY1)=1
(  113)   fields(FIELD_XVEL1)=1
(  114)   fields(FIELD_YVEL1)=1
(  115)   fields(FIELD_ZVEL1)=1
(  116)   fields(FIELD_MASS_FLUX_X)=1
(  117)   fields(FIELD_MASS_FLUX_Y)=1
(  118)   fields(FIELD_MASS_FLUX_Z)=1
(  119)   IF(profiler_on) kernel_time=timer()
(  120)   CALL update_halo(fields,2)
(  121)   IF(profiler_on) profiler%halo_exchange=profiler%halo_exchange+(timer()-kernel_time)
(  122) 
(  123)   IF(profiler_on) kernel_time=timer()
(  124)   DO c=1,chunks_per_task
(  125)     CALL advec_mom_driver(c,xvel,direction,sweep_number) 
(  126)   ENDDO
(  127)   DO c=1,chunks_per_task
(  128)     CALL advec_mom_driver(c,yvel,direction,sweep_number) 
(  129)   ENDDO
(  130)   DO c=1,chunks_per_task
(  131)     CALL advec_mom_driver(c,zvel,direction,sweep_number) 
(  132)   ENDDO
(  133)   IF(profiler_on) profiler%mom_advection=profiler%mom_advection+(timer()-kernel_time)
(  134) 
(  135)   sweep_number=3
(  136)   IF(advect_x)      direction=g_zdir
(  137)   IF(.not.advect_x) direction=g_xdir
(  138) 
(  139)   IF(profiler_on) kernel_time=timer()
(  140)   DO c=1,chunks_per_task
(  141)     CALL advec_cell_driver(c,sweep_number,direction)
(  142)   ENDDO
(  143)   IF(profiler_on) profiler%cell_advection=profiler%cell_advection+(timer()-kernel_time)
(  144) 
(  145)   fields=0
(  146)   fields(FIELD_DENSITY1)=1
(  147)   fields(FIELD_ENERGY1)=1
(  148)   fields(FIELD_XVEL1)=1
(  149)   fields(FIELD_YVEL1)=1
(  150)   fields(FIELD_ZVEL1)=1
(  151)   fields(FIELD_MASS_FLUX_X)=1
(  152)   fields(FIELD_MASS_FLUX_Y)=1
(  153)   fields(FIELD_MASS_FLUX_Z)=1
(  154)   IF(profiler_on) kernel_time=timer()
(  155)   CALL update_halo(fields,2)
(  156)   IF(profiler_on) profiler%halo_exchange=profiler%halo_exchange+(timer()-kernel_time)
(  157) 
(  158)   IF(profiler_on) kernel_time=timer()
(  159)   DO c=1,chunks_per_task
(  160)     CALL advec_mom_driver(c,xvel,direction,sweep_number) 
(  161)   ENDDO
(  162)   DO c=1,chunks_per_task
(  163)     CALL advec_mom_driver(c,yvel,direction,sweep_number) 
(  164)   ENDDO
(  165)   DO c=1,chunks_per_task
(  166)     CALL advec_mom_driver(c,zvel,direction,sweep_number) 






PGF90 (Version     13.5)          07/18/2014  14:45:36      page 4

(  167)   ENDDO
(  168)   IF(profiler_on) profiler%mom_advection=profiler%mom_advection+(timer()-kernel_time)
(  169) 
(  170) END SUBROUTINE advection
(  171) 
(  172) END MODULE advection_module
